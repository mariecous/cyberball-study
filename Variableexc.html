<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Cyberball – version animée</title>
<style>
  body { font-family: sans-serif; text-align: center; background: #ececec; }
  canvas { margin-top: 20px; background: white; border: 2px solid #333; cursor: pointer; }
  .hidden { display: none; }
  button { padding: 12px 25px; background: #007bff; border: none; border-radius: 10px; font-size: 18px; color: white; cursor: pointer; }
  a.btn-questionnaire { display: inline-block; padding: 10px 18px; background-color: #007BFF; color: white; text-decoration: none; border-radius: 6px; font-weight: bold; margin:10px 0; }
  a.btn-questionnaire:hover { background-color: #0056b3; }
</style>
</head>

<body>

<!-- ====================== PAGE D'ACCUEIL ====================== -->
<div id="welcome">
  <h1>Bienvenue dans l'étude Cyberball !</h1>
  <p>Cette étude est strictement anonyme et confidentielle.</p>

  <h2>Votre identifiant :</h2>
  <div style="font-size:26px;font-weight:bold;"><span id="generatedID"></span></div>

  <a href="https://questionnaires.univ-nantes.fr/index.php/732818?lang=fr" target="_blank" class="btn-questionnaire">
    Répondre au questionnaire n°1
  </a>

  <p>Après le questionnaire, cliquez ci-dessous pour lancer le Cyberball.</p>
  <button id="goCyber">Passer au Cyberball</button>
</div>

<!-- ====================== CYBERBALL ====================== -->
<h1 id="title" class="hidden">CYBERBALL</h1>
<p id="instructions" class="hidden">Cliquez sur « Commencer ».</p>
<button id="startBtn" class="hidden">Commencer</button>

<div id="playerSelect" class="hidden"><h2>Choisissez votre personnage</h2></div>
<div id="loading" class="hidden"><h2>Connexion aux autres joueurs…</h2></div>
<canvas id="canvas" width="600" height="420" class="hidden"></canvas>

<!-- ====================== QUESTIONNAIRE FINAL ====================== -->
<div id="questionnaire" class="hidden">
  <h2>Merci d'avoir joué</h2>
  <a href="https://questionnaires.univ-nantes.fr/index.php/469666?lang=fr" target="_blank" class="btn-questionnaire">
    Répondre au questionnaire n°2
  </a>
</div>

<script>
// ====================== ID ======================
function generateID() {
  return "E" + Math.floor(1000 + Math.random() * 9000) + String.fromCharCode(65 + Math.floor(Math.random() * 26));
}
const id = generateID();
document.getElementById("generatedID").textContent = id;
localStorage.setItem("cyberballID", id);

// ====================== NAVIGATION ======================
document.getElementById("goCyber").onclick = () => {
  window.open(window.location.href + "#cyberball", "_blank");
};

if (window.location.hash === "#cyberball") {
  document.getElementById("welcome").classList.add("hidden");
  document.getElementById("title").classList.remove("hidden");
  document.getElementById("instructions").classList.remove("hidden");
  document.getElementById("startBtn").classList.remove("hidden");
}

// ====================== ELEMENTS ======================
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const startBtn = document.getElementById("startBtn");
const playerSelect = document.getElementById("playerSelect");
const loading = document.getElementById("loading");
const questionnaire = document.getElementById("questionnaire");

// ====================== PARAMÈTRES EXPÉRIMENTAUX ======================
const TOTAL_THROWS = 20;
const PASSES_TO_SELF = 4;
const THROW_DELAY = 1200;

let throws = 0;
let throwPlan = [];
let current = 0;
let hasBall = false;
let etatJeu = "start";

let players = [];
let ball = { x: -100, y: -100 };

// ====================== PERSONNAGES ======================
const characters = [
  { skin:"#f2d3b1", hair:"#7a4a1e", shirt:"#e6e6e6" },
  { skin:"#b88a65", hair:"#3f332a", shirt:"#7fc8f7" },
  { skin:"#9a6a4a", hair:"#777", shirt:"#e86a5d" }
];

const positions = [
  { x:100, y:260, isSelf:false, name:"Joueur 1" },
  { x:300, y:120, isSelf:true,  name:"Vous" },
  { x:500, y:260, isSelf:false, name:"Joueur 2" }
];

// ====================== PLAN DE PASSES ======================
function generateThrowPlan() {
  let plan = [];
  for (let i = 0; i < PASSES_TO_SELF; i++) plan.push("self");
  for (let i = 0; i < TOTAL_THROWS - PASSES_TO_SELF; i++) plan.push("other");

  for (let i = plan.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [plan[i], plan[j]] = [plan[j], plan[i]];
  }
  return plan;
}

// ====================== DESSIN ======================
function drawCharacter(p) {
  ctx.save();
  ctx.translate(p.x, p.y);
  ctx.fillStyle = p.shirt;
  ctx.fillRect(-20, 0, 40, 55);
  ctx.fillStyle = p.skin;
  ctx.beginPath();
  ctx.arc(0, -28, 18, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillStyle = p.hair;
  ctx.beginPath();
  ctx.arc(0, -35, 18, Math.PI, Math.PI * 2);
  ctx.fill();
  ctx.restore();
  ctx.fillText(p.name, p.x - 20, p.y + 90);
}

function drawScene() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  players.forEach(drawCharacter);
  ctx.beginPath();
  ctx.arc(ball.x, ball.y, 10, 0, Math.PI * 2);
  ctx.fillStyle = "orange";
  ctx.fill();
}

// ====================== ANIMATION ======================
function animateThrow(from, to, callback) {
  let steps = 30, t = 0;
  let sx = players[from].x, sy = players[from].y + 30;
  let tx = players[to].x, ty = players[to].y + 30;
  let dx = (tx - sx) / steps, dy = (ty - sy) / steps;

  let anim = setInterval(() => {
    ball.x = sx + dx * t;
    ball.y = sy + dy * t;
    drawScene();
    if (++t >= steps) {
      clearInterval(anim);
      current = to;
      callback();
    }
  }, 25);
}

// ====================== LOGIQUE ======================
function nextThrow() {
  if (throws >= TOTAL_THROWS) {
    canvas.classList.add("hidden");
    questionnaire.classList.remove("hidden");
    return;
  }

  if (players[current].isSelf) {
    hasBall = true;
    return;
  }

  const instruction = throwPlan[throws++];
  let to = instruction === "self" ? 1 : (current === 0 ? 2 : 0);

  animateThrow(current, to, () => {
    if (to === 1) hasBall = true;
    setTimeout(nextThrow, hasBall ? 0 : THROW_DELAY);
  });
}

// ====================== DÉMARRAGE ======================
startBtn.onclick = () => {
  startBtn.classList.add("hidden");
  playerSelect.classList.add("hidden");
  loading.classList.remove("hidden");

  players = positions.map((p, i) => ({ ...p, ...characters[i] }));
  throwPlan = generateThrowPlan();
  throws = 0;
  current = 0;

  setTimeout(() => {
    loading.classList.add("hidden");
    canvas.classList.remove("hidden");
    ball.x = players[0].x;
    ball.y = players[0].y + 30;
    drawScene();
    setTimeout(nextThrow, 1000);
  }, 2000);
};

// ====================== CLIC JOUEUR ======================
canvas.addEventListener("click", e => {
  if (!hasBall) return;
  const r = canvas.getBoundingClientRect();
  const x = e.clientX - r.left;
  const y = e.clientY - r.top;

  players.forEach((p, i) => {
    if (!p.isSelf && Math.hypot(p.x - x, p.y - y) < 80) {
      hasBall = false;
      animateThrow(1, i, () => {
        current = i;
        setTimeout(nextThrow, THROW_DELAY);
      });
    }
  });
});
</script>

</body>
</html>
